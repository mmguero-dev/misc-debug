### Setup

* install [my work-in-progress analyzer](https://github.com/mmguero-dev/icsnpp-synchrophasor)
    - `zkg install --skiptests --force https://github.com/mmguero-dev/icsnpp-synchrophasor`
* grab the `C37.118_1PMU_UDP_minimal.pcap` and `C37.118_1PMU_UDP_minimal.stream` from this directory

### List of files and directories

* `C37.118_1PMU_UDP_minimal.pcap`
    - PCAP containing minimal communication

* `C37.118_1PMU_UDP_minimal.stream`
    - Raw bytes containing UDP "stream" 0 from `C37.118_1PMU_UDP_minimal.pcap`
    - Generated via:
```bash
tshark -r /debug/C37.118_1PMU_UDP_minimal.pcap -e "udp.payload" -Tfields -Y udp.stream==0 | \
    sed "s/://g" | \
    xxd -r -p > \
    /debug/C37.118_1PMU_UDP_minimal.stream
```

* `spicy_dump_output.json`
    - output of:
```bash
spicy-dump -J -p SYNCHROPHASOR::Frames /icsnpp-synchrophasor/analyzer/synchrophasor.spicy \
    < /debug/C37.118_1PMU_UDP_minimal.stream \
    > /debug/spicy_dump_output.json
```

* `spicy_dump_output.txt`
    - output of:
```bash
spicy-dump -P -p SYNCHROPHASOR::Frames /icsnpp-synchrophasor/analyzer/synchrophasor.spicy \
    < /debug/C37.118_1PMU_UDP_minimal.stream \
    > /debug/spicy_dump_output.txt
```

* `logs/`
    - directory containing Zeek logs generated by `zeek -C -r /debug/C37.118_1PMU_UDP_minimal.pcap local misc/dump-events` after `zkg` installation of analyzer

* `zeek_dump_events.txt`
    - output of `zeek -C -r /debug/C37.118_1PMU_UDP_minimal.pcap local misc/dump-events` after `zkg` installation of analyzer

* `zeek_hlto_hilti_debug.txt`
    - following some of the steps from [7.8 Debugging](https://docs.zeek.org/projects/spicy/en/latest/zeek.html#debugging)
        + compiled with `spicyz -d -D zeek synchrophasor.spicy synchrophasor.evt -o synchrophasor.hlto`
        + this text file is output of `HILTI_DEBUG=zeek zeek -B dpd -Cr /debug/C37.118_1PMU_UDP_minimal.pcap synchrophasor.hlto`
        + not sure why the log files weren't generated when I ran this command but I don't think it matters, as the `event SYNCHROPHASOR::DataFrame` line illustrates the issue

### Issue

The `spicy-dump` output does not match the Zeek output as illustrated here:

#### Expected (correct)

Notice the `DATA_FRAME` structure from the `spicy-dump` output (I've replaced some stuff here with `⋯` to make it more readable, but the output in the `spicy_dump_output.json` and `spicy_dump_output.txt` files is complete): Note that the `initialized` values are `True` (a value I set when the units are parsed "correctly" and match what they're expected to match), and that `numPMUActual` and `numPMUExpected` are both `1`. The `pmuFound` field indicates that I was able to find the index into the vector of previous frames that was needed to decode this data frame. This data all looks correct.

```
SYNCHROPHASOR::Frame {
  parseError: False
  header: SYNCHROPHASOR::FrameHeader {
    timeStamp: 2008-08-01T16:18:11.000000000Z
    sync: SYNCHROPHASOR::SyncField {
      frameType: DATA_FRAME
      version: 1
    }
    frameSize: 48
    dataStreamId: 60
    fracSec: SYNCHROPHASOR::FracSec {
      fracSec: 0.58
      data: (fracSecRaw: 580000, qualityIndicator: 0, leapSecPending: 0, leapSecOccurred: 0, leapSecDirection: 0, _: 0)
    }
  }
  _payload: ⋯
  chk: 6812
  DATA_FRAME: SYNCHROPHASOR::DataFrame {
    initialized: True
    cfgFrame: SYNCHROPHASOR::ConfigFrame { ⋯ }
    cfgFound: True
    numPMUExpected: 1
    numPMUActual: 1
    data: [
      SYNCHROPHASOR::PMUData {
        initialized: True
        pmuFound: True
        pmuIdx: 0
        pmuCfg: SYNCHROPHASOR::PMUConfig { ⋯ }
        stat: (⋯)
        phasors: [ ⋯ ]
        freq: SYNCHROPHASOR::FrequencyDeviation { ⋯ }
        dfreq: SYNCHROPHASOR::ROCOF { ⋯ }
        digital: [ ⋯ ]
      }
    ]
  }
}
```

#### Actual (incorrect)

The first thing I noticed was the value in the `synchrophasor_data.log` file didn't look right:

```
#separator \x09
#set_separator  ,
#empty_field    (empty)
#unset_field    -
#path   synchrophasor_data
#open   2023-03-07-14-36-03
#fields ts  uid id.orig_h   id.orig_p   id.resp_h   id.resp_p   proto   frame_type  pmu_count_expected  pmu_count_actual
#types  time    string  addr    port    addr    port    string  string  count   count
1218023578.629213   CbroLJ1aUIO6OyD1a9  192.168.0.10    4712    192.168.0.60    4713    udp Data    0   16
#close  2023-03-07-14-36-03
```

What tipped me off here was that the `pmu_count_expected` and `pmu_count_actual` values are `0` and `16`, respectively, when I expected them to both be `1`. I checked the `main.zeek` file's [event](https://github.com/mmguero-dev/icsnpp-synchrophasor/blob/4c9269bd342ced5eb8c27831c6cea4e6e8d2952a/analyzer/main.zeek#L485-L496) and [record](https://github.com/mmguero-dev/icsnpp-synchrophasor/blob/4c9269bd342ced5eb8c27831c6cea4e6e8d2952a/analyzer/main.zeek#L98-L107) for this log, and compared it with the [`.evt` file](https://github.com/mmguero-dev/icsnpp-synchrophasor/blob/4c9269bd342ced5eb8c27831c6cea4e6e8d2952a/analyzer/synchrophasor.evt#L51-L62) and the [originating unit](https://github.com/mmguero-dev/icsnpp-synchrophasor/blob/4c9269bd342ced5eb8c27831c6cea4e6e8d2952a/analyzer/synchrophasor.spicy#L336-L396) and from what I can tell they seem to match.

Looking at the corresponding line in `zeek_hlto_hilti_debug.txt`, I see things don't look right either:

```
[zeek] [SPICY_SYNCHROPHASOR_UDP/3/resp] -> event SYNCHROPHASOR::DataFrame($conn, $is_orig, FrameTypeCode::DATA_FRAME, 2008-08-01T16:18:11.000000000Z, 48, 6812, 1, 60, false, 0, 16)
```

The `initialized` value is `false` and the `pmu_count_expected` and `pmu_count_actual` values are `0` and `16`.

The `zeek_dump_events.txt` which is just another way of looking at the same thing also looks wrong:

```
1218023578.629213 SYNCHROPHASOR::DataFrame
                  [0] c: connection      = [⋯]
                  [1] is_orig: bool      = F
                  [2] frameType: SYNCHROPHASOR::FrameTypeCode = SYNCHROPHASOR::FrameTypeCode_DATA_FRAME
                  [3] timeStamp: time    = 1217607491.0
                  [4] frameSize: count   = 48
                  [5] chk: count         = 6812
                  [6] version: count     = 1
                  [7] dataStreamId: count = 60
                  [8] initialized: bool  = F
                  [9] numPMUExpected: count = 0
                  [10] numPMUActual: count = 16
```

### Other Observations

1. `logs/notice.log`
    - `CaptureLoss::Too_Little_Traffic  Only observed 0 TCP ACKs and was expecting at least 1`
        + What's up with this? Is this just a normal occurance for a PCAP with no TCP traffic, or for some reason is Zeek thinking it should expect to see some TCP traffic? `logs/telemetry.log` lists 0 TCP sessions and 1 UDP session so maybe this isn't an issue.

### Hypotheses

* I've got something defined incorrectly in the event? I'm not sure how, though, as I have [several traces](https://github.com/mmguero-dev/icsnpp-synchrophasor/tree/main/tests/traces) that do this exact thing many times over TCP and they don't have the issue.
* Something happens different timings-wise between TCP and UDP streams that I don't understand?
* I've done something wrong registering or confirming the protocol for UDP vs TCP? I do see the `spicy_synchrophasor_udp` for the protocol in conn.log so that doesn't seem likely to me.
* ???